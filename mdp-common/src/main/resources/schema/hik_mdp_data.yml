---
name: hik-mdp-data-collector
properties:
  kafka.bootstrap.servers: 10.17.139.66:9092
  kafka.zookeeper.connector: 10.17.139.66:2181
  hbase.zookeeper.quorum: 10.17.139.66
  hbase.zookeeper.property.clientPort: 2181
  hbase.table.name: HIK_MDP_CELLPHONE
  # policeHash: Hash分配, policeAvg: 平均分配
  hbase.region.strategy: policeAvg
  rowkey.expression: hashFormatAndInsert(formatTime(timestamp_,'yyyyMM')+formatString(target_type,'%03d')+formatTime(timestamp_,'dd')+'_'+global_id,999,0,'%03d',6)
  collector.parser: pb
  db.url: jdbc:postgresql:///mdp
  db.username: postgres
  db.password: postgres
schemas:
  - name: hik_mdp_cellphone_schema
  #TODO 确定哪些字段是必须的 (optional = true)
  #parameters -> 有检索需求的就加
    fields:
      #运营商
      - name: yys
        group: info
        index: 0
        # INT8, INT16, INT32, INT64, FLOAT32, FLOAT64, BOOLEAN, STRING, BYTES, ARRAY
        type: STRING
        optional: true
        parameters:
          index.type: es
          index.isStore: false
          index.isTokenized: false
      #业务类型
      - name: ywlx
        group: info
        index: 1
        type: STRING
        optional: true
        parameters:
          index.type: es
          index.isStore: false
          index.isTokenized: false
      #起始时间
      - name: qssj
        group: info
        index: 2
        type: STRING
        optional: true
        parameters:
          index.type: es
          index.isStore: false
          index.isTokenized: false
      #服务号码
      - name: fwhm
        group: info
        index: 3
        type: STRING
        optional: true
        parameters:
          index.type: es
          index.isStore: false
          index.isTokenized: false
      #卡号
      - name: kh
        group: info
        index: 4
        type: STRING
        optional: true
      #设备号码
      - name: sbhm
        group: info
        index: 5
        type: FLOAT32
        optional: true
      #对方号码
      - name: dfhm
        group: info
        index: 6
        type: FLOAT32
        optional: true
        parameters:
          index.type: es
          index.isStore: false
          index.isTokenized: false
      #对方号码归属地
      - name: dfhmgsd
        group: info
        index: 7
        type: INT32
        optional: true
        parameters:
          index.type: es
          index.isStore: false
          index.isTokenized: false
      #通话时长
      - name: thsc
        group: info
        index: 8
        type: INT64
        optional: true
        parameters:
          index.type: es
          index.isStore: false
          index.isTokenized: false
      #呼叫类型
      - name: hjlx
        group: info
        index: 9
        type: INT64
        optional: true
      #LAC
      - name: lac
        group: info
        index: 10
        type: INT32
        optional: true
        parameters:
          index.type: es
          index.isStore: false
          index.isTokenized: false
      #CID
      - name: cid
        group: info
        index: 11
        type: INT64
        optional: true
        parameters:
          index.type: es
          index.isStore: true
          index.isTokenized: false
      #服务号码基站
      - name: fwhmjz
        group: info
        index: 12
        type: INT32
        optional: true
        parameters:
          index.type: es
          index.isStore: false
          index.isTokenized: false
      #MSC
      - name: msc
        group: info
        index: 13
        type: STRING
        optional: true
      #城市
      - name: cs
        group: info
        index: 14
        type: STRING
        optional: true
        parameters:
          index.type: es
          index.isStore: false
          index.isTokenized: false
      #第三方号码
      - name: dsfhm
        group: info
        index: 15
        type: STRING
        optional: true
      #第三方号码归属地
      - name: dsfhmgsd
        group: info
        index: 16
        type: INT32
        optional: true
topics:
  - name: hik_mdp_cellphone_topic
    partitions: 10
    replicas: 1
    schema: hik_mdp_cellphone_schema
    properties:
          cleanup.policy: delete
  - name: hik_mdp_cellphone
    partitions: 10
    replicas: 1
    schema: hik_mdp_cellphone_schema
    properties:
          cleanup.policy: delete
  - name: test
    partitions: 10
    replicas: 1
    schema: test
    properties:
          cleanup.policy: delete

connectors:
  # 批量写HBase和Kafka
  - name: hik_mdp_cellphone_topic
    className: com.hikvision.bigdata.hbp.datacollectors.connector.v2.dag.impl.DAGConnectorImpl
    parals: 1
    properties:
      connector.resources.cores: 1
      connector.resources.memory.mb: 2048
      max.record.buffer.size: 2000
    dispatcher:
      className: com.hikvision.bigdata.hbp.datacollectors.connector.v2.dag.impl.DAGDispatcherImpl
      properties:
        max.idle.time.ms: 60000
    from:
      className: com.hikvision.bigdata.hbp.datacollectors.connector.v2.dag.impl.KafkaPoller
      properties:
        converter: com.hikvision.bigdata.hbp.datacollectors.connector.v2.converter.impl.DefaultKafkaConverterImpl
        topic: hik_mdp_cellphone_topic
        schema: hik_mdp_cellphone_schema
        max.commit.retries: 60000
    to:
      processors:
        - name: sendtohbase
          className: com.hikvision.bigdata.hbp.datacollectors.connector.v2.dag.impl.SendToHBaseProcessor
          properties:
            metrics.prefix: sendtoHikMdpInfo
            table: hik_mdp_cellphone
            hbase.conf:
              hbase.zookeeper.quorum: lark001:2181
        - name: sendtohbasesi
          className: com.hikvision.bigdata.hbp.datacollectors.connector.v2.dag.impl.SendToHBaseProcessor
          properties:
            metrics.prefix: sendtoHikMdpIndexInfo
            table: ssdTable:hik_mdp_index_info
            hbase.conf:
              hbase.zookeeper.quorum: lark001:2181
            converter: com.hikvision.bigdata.hbp.datacollectors.connector.v2.converter.impl.HBaseSecondaryIndexConverterImpl
          waitFor:
            - sendtohbase
        - name: sendtoes
          className: com.hikvision.bigdata.hbp.datacollectors.connector.v2.dag.impl.SendToElasticSearchWithJestProcessor
          properties:
            index: hik_mdp_index_info
            type: hikmdpindexinfotype
            router: DATE_FIELD
            router.field: qssj
            router.rules: day:1
            router.rules.locale: zh-cn
            router.rules.timezone: GMT
            es.rest.addresses: lark001:9200
          waitFor:
            - sendtohbasesi